{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kinetic-rs/schemas/workflow.schema.json",
  "title": "Kinetic Workflow Definition",
  "description": "Schema for defining kinetic-rs workflows and agents",
  "type": "object",
  "required": ["name", "description", "kind"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Unique name for this workflow or agent"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this workflow does"
    },
    "kind": {
      "type": "string",
      "enum": ["Direct", "Composite"],
      "description": "Type of workflow: 'Direct' for single agent, 'Composite' for multi-agent workflows"
    },
    "stream": {
      "type": "boolean",
      "default": false,
      "description": "Whether to stream the output"
    },
    "agent": {
      "$ref": "#/$defs/AgentDefinition",
      "description": "Agent definition (required for 'Direct' kind)"
    },
    "workflow": {
      "$ref": "#/$defs/CompositeWorkflowDefinition",
      "description": "Workflow definition (required for 'Composite' kind)"
    },
    "mcp_servers": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/McpServerConfig"
      },
      "default": [],
      "description": "MCP servers to connect to for additional tools"
    },
    "overrides": {
      "type": "object",
      "additionalProperties": true,
      "description": "Override values for referenced workflows"
    },
    "output": {
      "$ref": "#/$defs/OutputDefinition",
      "description": "Output configuration"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "kind": { "const": "Direct" } }
      },
      "then": {
        "required": ["agent"]
      }
    },
    {
      "if": {
        "properties": { "kind": { "const": "Composite" } }
      },
      "then": {
        "required": ["workflow"]
      }
    }
  ],
  "$defs": {
    "AgentDefinition": {
      "type": "object",
      "required": ["name", "description", "instructions", "model", "tools"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Agent name"
        },
        "description": {
          "type": "string",
          "description": "Agent description"
        },
        "instructions": {
          "type": "string",
          "description": "System prompt/instructions for the agent"
        },
        "model": {
          "$ref": "#/$defs/ModelDefinition"
        },
        "tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of tool names the agent can use"
        },
        "memory": {
          "$ref": "#/$defs/MemoryDefinition"
        },
        "output": {
          "$ref": "#/$defs/OutputDefinition"
        }
      }
    },
    "ModelDefinition": {
      "type": "object",
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["llm"],
          "default": "llm",
          "description": "Model kind"
        },
        "provider": {
          "type": "string",
          "enum": ["Gemini", "OpenAI", "Anthropic", "DeepSeek"],
          "description": "LLM provider. Optional - inferred from model_name or MODEL_PROVIDER env var. Defaults to Gemini."
        },
        "model_name": {
          "type": "string",
          "description": "Specific model name (e.g., 'gemini-2.0-flash', 'gpt-4'). Defaults to MODEL_NAME or GEMINI_MODEL env var."
        },
        "parameters": {
          "type": "object",
          "properties": {
            "temperature": {
              "type": "number",
              "minimum": 0,
              "maximum": 2,
              "description": "Sampling temperature (0-2)"
            },
            "max_tokens": {
              "type": "integer",
              "minimum": 1,
              "description": "Maximum tokens in response"
            },
            "top_p": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Top-p sampling parameter"
            }
          },
          "additionalProperties": true
        }
      }
    },
    "MemoryDefinition": {
      "type": "object",
      "required": ["kind"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["sliding_window", "summary", "none"],
          "description": "Type of memory management"
        },
        "parameters": {
          "type": "object",
          "properties": {
            "window_size": {
              "type": "integer",
              "minimum": 1,
              "description": "Number of messages to keep in sliding window"
            }
          },
          "additionalProperties": true
        }
      }
    },
    "CompositeWorkflowDefinition": {
      "type": "object",
      "required": ["execution", "agents"],
      "properties": {
        "execution": {
          "type": "string",
          "enum": ["sequential", "parallel", "loop"],
          "description": "How to execute the agents: sequential (one after another), parallel (concurrently), or loop (repeat until condition)"
        },
        "agents": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/AgentConfig"
          },
          "minItems": 1,
          "description": "List of agents or workflow references to execute"
        },
        "max_iterations": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum iterations for loop execution"
        }
      }
    },
    "AgentConfig": {
      "oneOf": [
        {
          "$ref": "#/$defs/AgentDefinition",
          "description": "Inline agent definition"
        },
        {
          "$ref": "#/$defs/WorkflowReference",
          "description": "Reference to external workflow/agent file"
        }
      ]
    },
    "WorkflowReference": {
      "type": "object",
      "required": ["file"],
      "properties": {
        "file": {
          "type": "string",
          "description": "Path to the workflow/agent YAML file (relative to project root)"
        },
        "overrides": {
          "type": "object",
          "additionalProperties": true,
          "description": "Override values for the referenced workflow"
        }
      },
      "additionalProperties": false
    },
    "McpServerConfig": {
      "type": "object",
      "required": ["name", "command", "args"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique name for this MCP server"
        },
        "command": {
          "type": "string",
          "description": "Command to run the MCP server (e.g., 'npx', 'python')"
        },
        "args": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Arguments to pass to the command"
        }
      }
    },
    "OutputDefinition": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["text", "json", "markdown"],
          "default": "text",
          "description": "Output format type"
        }
      }
    }
  }
}

